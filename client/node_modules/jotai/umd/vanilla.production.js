!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((n="undefined"!=typeof globalThis?globalThis:n||self).jotaiVanilla={})}(this,(function(n){"use strict";var e=0;function r(n){return n(this)}function t(n,e,r){return e(this,"function"==typeof r?r(n(this)):r)}function o(n,e){(null==e||e>n.length)&&(e=n.length);for(var r=0,t=Array(e);r<e;r++)t[r]=n[r];return t}function a(n,e){var r="undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(r)return(r=r.call(n)).next.bind(r);if(Array.isArray(n)||(r=function(n,e){if(n){if("string"==typeof n)return o(n,e);var r={}.toString.call(n).slice(8,-1);return"Object"===r&&n.constructor&&(r=n.constructor.name),"Map"===r||"Set"===r?Array.from(n):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?o(n,e):void 0}}(n))||e){r&&(n=r);var t=0;return function(){return t>=n.length?{done:!0}:{done:!1,value:n[t++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,u=function(n,e){return n.unstable_is?n.unstable_is(e):e===n},f=function(n){return"init"in n},l=function(n){return!!n.write},v=new WeakMap,c=function(n){var e;return d(n)&&!(null!=(e=v.get(n))&&e[1])},d=function(n){return"function"==typeof(null==n?void 0:n.then)},s=function(n){return"v"in n||"e"in n},h=function(n){if("e"in n)throw n.e;return n.v},p=function(n,e,r){r.p.has(n)||(r.p.add(n),e.then((function(){r.p.delete(n)}),(function(){r.p.delete(n)})))},y=function(n,e,r,t,o){var a;r.d.set(t,o.n),c(r.v)&&p(e,r.v,o),null==(a=o.m)||a.t.add(e),n&&g(n,t,e)},m=function(){return[new Map,new Map,new Set]},w=function(n,e,r){n[0].has(e)||n[0].set(e,new Set),n[1].set(e,r)},g=function(n,e,r){var t=n[0].get(e);t&&t.add(r)},b=function(n,e){n[2].add(e)},S=function(n){for(;n[1].size||n[2].size;){n[0].clear();var e=new Set(n[1].values());n[1].clear();var r=new Set(n[2]);n[2].clear(),e.forEach((function(n){var e;return null==(e=n.m)?void 0:e.l.forEach((function(n){return n()}))})),r.forEach((function(n){return n()}))}},A=function(n){var e=function(e,r,t){var o,i,u,f="v"in r,l=r.v,s=c(r.v)?r.v:null;if(d(t)){!function(n){if(!v.has(n)){var e=[new Set,!1];v.set(n,e);var r=function(){e[1]=!0};n.then(r,r),n.onCancel=function(n){e[0].add(n)}}}(t);for(var h,y=a(r.d.keys());!(h=y()).done;){var m=h.value;p(e,t,n(m,r))}r.v=t,delete r.e}else r.v=t,delete r.e;f&&Object.is(l,r.v)||(++r.n,s&&(o=s,i=t,(u=v.get(o))&&(u[1]=!0,u[0].forEach((function(n){return n(i)})))))},r=function(t,o,a,v){if(s(a)){if(a.m&&(null==v||!v.has(o)))return a;if(Array.from(a.d).every((function(e){var o=e[0],i=e[1];return r(t,o,n(o,a),v).n===i})))return a}a.d.clear();var c,p,w=!0,b={get signal(){return c||(c=new AbortController),c.signal},get setSelf(){return!p&&l(o)&&(p=function(){if(!w){for(var n=arguments.length,e=new Array(n),r=0;r<n;r++)e[r]=arguments[r];return i.apply(void 0,[o].concat(e))}}),p}};try{var A=o.read((function(i){if(u(o,i)){var l=n(i,a);if(!s(l)){if(!f(i))throw new Error("no atom init");e(i,l,i.init)}return h(l)}var c=r(t,i,n(i,a),v);if(w)y(t,o,a,i,c);else{var d=m();y(d,o,a,i,c),g(d,o,a),S(d)}return h(c)}),b);if(e(o,a,A),d(A)){null==A.onCancel||A.onCancel((function(){var n;return null==(n=c)?void 0:n.abort()}));var k=function(){if(a.m){var n=m();g(n,o,a),S(n)}};A.then(k,k)}return a}catch(n){return delete a.v,a.e=n,++a.n,a}finally{w=!1}},t=function(e,t,o){var i=[],u=new Set,f=function(r,t){if(!u.has(r)){u.add(r);for(var o,l=a(function(e,r,t){for(var o,i,u=new Map,f=a((null==(l=t.m)?void 0:l.t)||[]);!(i=f()).done;){var l,v=i.value;u.set(v,n(v,t))}for(var c,d=a(t.p);!(c=d()).done;){var s=c.value;u.set(s,n(s,t))}return null==(o=function(n,e){return n[0].get(e)}(e,r))||o.forEach((function(e){u.set(e,n(e,t))})),u}(e,r,t));!(o=l()).done;){var v=o.value,c=v[0],d=v[1];r!==c&&f(c,d)}i.push([r,t,t.n])}};f(t,o);for(var l=new Set([t]),v=i.length-1;v>=0;--v){for(var c,d=i[v],s=d[0],h=d[1],p=d[2],y=!1,m=a(h.d.keys());!(c=m()).done;){var b=c.value;if(b!==s&&l.has(b)){y=!0;break}}y&&(r(e,s,h,u),g(e,s,h),p!==h.n&&(w(e,s,h),l.add(s))),u.delete(s)}},o=function(a,i,l){for(var v=arguments.length,c=new Array(v>3?v-3:0),d=3;d<v;d++)c[d-3]=arguments[d];var s=i.write.apply(i,[function(e){return h(r(a,e,n(e,l)))},function(r){for(var v,c=n(r,l),d=arguments.length,s=new Array(d>1?d-1:0),h=1;h<d;h++)s[h-1]=arguments[h];if(u(i,r)){if(!f(r))throw new Error("atom not writable");var p="v"in c,y=c.v,m=s[0];e(r,c,m),g(a,r,c),p&&Object.is(y,c.v)||(w(a,r,c),t(a,r,c))}else v=o.apply(void 0,[a,r,c].concat(s));return S(a),v}].concat(c));return s},i=function(e){for(var r=m(),t=arguments.length,a=new Array(t>1?t-1:0),i=1;i<t;i++)a[i-1]=arguments[i];var u=o.apply(void 0,[r,e,n(e)].concat(a));return S(r),u},g=function(e,r,t){if(t.m&&!c(t.v)){for(var o,i=a(t.d.keys());!(o=i()).done;){var u=o.value;if(!t.m.d.has(u))k(e,u,n(u,t)).t.add(r),t.m.d.add(u)}for(var f,l=a(t.m.d||[]);!(f=l()).done;){var v=f.value;if(!t.d.has(v)){t.m.d.delete(v);var d=M(e,v,n(v,t));null==d||d.t.delete(r)}}}},k=function(e,t,i){if(!i.m){r(e,t,i);for(var u,f=a(i.d.keys());!(u=f()).done;){var v=u.value;k(e,v,n(v,i)).t.add(t)}if(i.m={l:new Set,d:new Set(i.d.keys()),t:new Set},l(t)&&t.onMount){var c=i.m,d=t.onMount;b(e,(function(){var n=d((function(){for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return o.apply(void 0,[e,t,i].concat(r))}));n&&(c.u=n)}))}}return i.m},M=function(e,r,t){if(!t.m||t.m.l.size||Array.from(t.m.t).some((function(e){var o;return null==(o=n(e,t).m)?void 0:o.d.has(r)})))return t.m;var o=t.m.u;o&&b(e,o),delete t.m;for(var i,u=a(t.d.keys());!(i=u()).done;){var f=i.value,l=M(e,f,n(f,t));null==l||l.t.delete(r)}},E={get:function(e){return h(r(void 0,e,n(e)))},set:i,sub:function(e,r){var t=m(),o=n(e),a=k(t,e,o);S(t);var i=a.l;return i.add(r),function(){i.delete(r);var n=m();M(n,e,o),S(n)}},unstable_derive:function(e){return A.apply(void 0,e(n))}};return E},k=function(){var n=new WeakMap;return A((function(e){var r=n.get(e);return r||(r={d:new Map,p:new Set,n:0},n.set(e,r)),r}))};n.atom=function(n,o){var a="atom"+ ++e,i={toString:function(){return a}};return"function"==typeof n?i.read=n:(i.init=n,i.read=r,i.write=t),o&&(i.write=o),i},n.createStore=k,n.getDefaultStore=function(){return i||(i=k()),i}}));
