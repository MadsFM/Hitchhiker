!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((n="undefined"!=typeof globalThis?globalThis:n||self).jotaiVanilla={})}(this,(function(n){"use strict";var e=0;function t(n){return n(this)}function r(n,e,t){return e(this,"function"==typeof t?t(n(this)):t)}function o(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,r=Array(e);t<e;t++)r[t]=n[t];return r}function a(n,e){var t="undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(t)return(t=t.call(n)).next.bind(t);if(Array.isArray(n)||(t=function(n,e){if(n){if("string"==typeof n)return o(n,e);var t={}.toString.call(n).slice(8,-1);return"Object"===t&&n.constructor&&(t=n.constructor.name),"Map"===t||"Set"===t?Array.from(n):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?o(n,e):void 0}}(n))||e){t&&(n=t);var r=0;return function(){return r>=n.length?{done:!0}:{done:!1,value:n[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,u=function(n,e){return n.unstable_is?n.unstable_is(e):e===n},f=function(n){return"init"in n},l=function(n){return!!n.write},c=Symbol(""),v="pending",d=new WeakMap,s=function(n){return"v"in n||"e"in n},m=function(n){if("e"in n)throw n.e;return n.v},p=function(n){var e,t=n.v;return"object"==typeof(e=t)&&null!==e&&c in e&&t.status===v?t:null},y=function(n,e,t){t.p.has(n)||(t.p.add(n),e.then((function(){t.p.delete(n)}),(function(){t.p.delete(n)})))},h=function(n,e,t,r,o){var a;t.d.set(r,o.n);var i=p(t);i&&y(e,i,o),null==(a=o.m)||a.t.add(e),n&&b(n,r,e)},w=function(){return[new Map,new Map,new Set]},g=function(n,e,t){n[0].has(e)||n[0].set(e,new Set),n[1].set(e,t)},b=function(n,e,t){var r=n[0].get(e);r&&r.add(t)},S=function(n,e){n[2].add(e)},A=function(n){for(;n[1].size||n[2].size;){n[0].clear();var e=new Set(n[1].values());n[1].clear();var t=new Set(n[2]);n[2].clear(),e.forEach((function(n){var e;return null==(e=n.m)?void 0:e.l.forEach((function(n){return n()}))})),t.forEach((function(n){return n()}))}},k=function(n){var e=function(e,t,r,o,i){void 0===o&&(o=function(){}),void 0===i&&(i=function(){});var u,f="v"in t,l=t.v,s=p(t);if("function"==typeof(null==(u=r)?void 0:u.then))if(s)s!==r&&(s[c](r,o),++t.n);else{var m=function(n,e,t){if(!d.has(n)){var r,o=new Promise((function(a,i){var u=n,f=function(n){return function(e){u===n&&(o.status="fulfilled",o.value=e,a(e),t())}},l=function(n){return function(e){u===n&&(o.status="rejected",o.reason=e,i(e),t())}};n.then(f(n),l(n)),r=function(n,t){n&&(d.set(n,o),u=n,n.then(f(n),l(n)),e(),e=t)}}));o.status=v,o[c]=r,d.set(n,o)}return d.get(n)}(r,o,i);if(m.status===v)for(var h,w=a(t.d.keys());!(h=w()).done;){var g=h.value;y(e,m,n(g,t))}t.v=m,delete t.e}else s&&s[c](Promise.resolve(r),o),t.v=r,delete t.e;f&&Object.is(l,t.v)||++t.n},t=function(r,o,a,c){if((null==c||!c(o))&&s(a)){if(a.m)return a;if(Array.from(a.d).every((function(e){var o=e[0],i=e[1];return t(r,o,n(o,a),c).n===i})))return a}a.d.clear();var v,d,p=!0,y={get signal(){return v||(v=new AbortController),v.signal},get setSelf(){return!d&&l(o)&&(d=function(){if(!p){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];return i.apply(void 0,[o].concat(e))}}),d}};try{var g=o.read((function(i){if(u(o,i)){var l=n(i,a);if(!s(l)){if(!f(i))throw new Error("no atom init");e(i,l,i.init)}return m(l)}var v=t(r,i,n(i,a),c);if(p)h(r,o,a,i,v);else{var d=w();h(d,o,a,i,v),b(d,o,a),A(d)}return m(v)}),y);return e(o,a,g,(function(){var n;return null==(n=v)?void 0:n.abort()}),(function(){if(a.m){var n=w();b(n,o,a),A(n)}})),a}catch(n){return delete a.v,a.e=n,++a.n,a}finally{p=!1}},r=function(e,r,o){var i=[],u=new Set,f=function(t,r){if(!u.has(t)){u.add(t);for(var o,l=a(function(e,t,r){for(var o,i,u=new Map,f=a((null==(l=r.m)?void 0:l.t)||[]);!(i=f()).done;){var l,c=i.value;u.set(c,n(c,r))}for(var v,d=a(r.p);!(v=d()).done;){var s=v.value;u.set(s,n(s,r))}return null==(o=function(n,e){return n[0].get(e)}(e,t))||o.forEach((function(e){u.set(e,n(e,r))})),u}(e,t,r));!(o=l()).done;){var c=o.value,v=c[0],d=c[1];t!==v&&f(v,d)}i.push([t,r,r.n])}};f(r,o);for(var l=new Set([r]),c=function(n){return u.has(n)},v=i.length-1;v>=0;--v){for(var d,s=i[v],m=s[0],p=s[1],y=s[2],h=!1,w=a(p.d.keys());!(d=w()).done;){var S=d.value;if(S!==m&&l.has(S)){h=!0;break}}h&&(t(e,m,p,c),b(e,m,p),y!==p.n&&(g(e,m,p),l.add(m))),u.delete(m)}},o=function(a,i,l){for(var c=arguments.length,v=new Array(c>3?c-3:0),d=3;d<c;d++)v[d-3]=arguments[d];var s=i.write.apply(i,[function(e){return m(t(a,e,n(e,l)))},function(t){for(var c,v=n(t,l),d=arguments.length,s=new Array(d>1?d-1:0),m=1;m<d;m++)s[m-1]=arguments[m];if(u(i,t)){if(!f(t))throw new Error("atom not writable");var p="v"in v,y=v.v,h=s[0];e(t,v,h),b(a,t,v),p&&Object.is(y,v.v)||(g(a,t,v),r(a,t,v))}else c=o.apply(void 0,[a,t,v].concat(s));return A(a),c}].concat(v));return s},i=function(e){for(var t=w(),r=arguments.length,a=new Array(r>1?r-1:0),i=1;i<r;i++)a[i-1]=arguments[i];var u=o.apply(void 0,[t,e,n(e)].concat(a));return A(t),u},b=function(e,t,r){if(r.m&&!p(r)){for(var o,i=a(r.d.keys());!(o=i()).done;){var u=o.value;if(!r.m.d.has(u))M(e,u,n(u,r)).t.add(t),r.m.d.add(u)}for(var f,l=a(r.m.d||[]);!(f=l()).done;){var c=f.value;if(!r.d.has(c)){r.m.d.delete(c);var v=j(e,c,n(c,r));null==v||v.t.delete(t)}}}},M=function(e,r,i){if(!i.m){t(e,r,i);for(var u,f=a(i.d.keys());!(u=f()).done;){var c=u.value;M(e,c,n(c,i)).t.add(r)}if(i.m={l:new Set,d:new Set(i.d.keys()),t:new Set},l(r)&&r.onMount){var v=i.m,d=r.onMount;S(e,(function(){var n=d((function(){for(var n=arguments.length,t=new Array(n),a=0;a<n;a++)t[a]=arguments[a];return o.apply(void 0,[e,r,i].concat(t))}));n&&(v.u=n)}))}}return i.m},j=function(e,t,r){if(!r.m||r.m.l.size||Array.from(r.m.t).some((function(e){var o;return null==(o=n(e,r).m)?void 0:o.d.has(t)})))return r.m;var o=r.m.u;o&&S(e,o),delete r.m;for(var i,u=a(r.d.keys());!(i=u()).done;){var f=i.value,l=j(e,f,n(f,r));null==l||l.t.delete(t)}var v=p(r);v&&v[c](void 0,(function(){}))},E={get:function(e){return m(t(void 0,e,n(e)))},set:i,sub:function(e,t){var r=w(),o=n(e),a=M(r,e,o);A(r);var i=a.l;return i.add(t),function(){i.delete(t);var n=w();j(n,e,o),A(n)}},unstable_derive:function(e){return k.apply(void 0,e(n))}};return E},M=function(){var n=new WeakMap;return k((function(e){var t=n.get(e);return t||(t={d:new Map,p:new Set,n:0},n.set(e,t)),t}))};n.atom=function(n,o){var a="atom"+ ++e,i={toString:function(){return a}};return"function"==typeof n?i.read=n:(i.init=n,i.read=t,i.write=r),o&&(i.write=o),i},n.createStore=M,n.getDefaultStore=function(){return i||(i=M()),i}}));
